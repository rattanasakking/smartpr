<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการข้อมูล (CRUD)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; }
        #dataTable th:last-child, #dataTable td:last-child { width: 150px; text-align: center; }
        #dataTable th:first-child, #dataTable td:first-child { width: 70px; }
        .table-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body class="container">

    <h2 class="mb-4">ระบบจัดการข้อมูล (เชื่อมต่อ Google Sheet)</h2>

    <div class="card mb-4">
        <div class="card-header">
            <h3 id="formTitle">เพิ่มข้อมูลใหม่</h3>
        </div>
        <div class="card-body">
            <form id="createForm">
                <div class="mb-3">
                    <label for="awsner" class="form-label">Awsner</label>
                    <input type="text" class="form-control" id="awsner" required>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">Content</label>
                    <input type="text" class="form-control" id="content" placeholder="โปรดใส่ข้อความ..." required>
                </div>
                <div class="mb-3">
                    <label for="type" class="form-label">Type</label>
                    <select class="form-select" id="type" required>
                        <option value="text" selected>Text</option>
                        <option value="image">Image</option>
                    </select>
                </div>
                
                <input type="hidden" id="editModeId" value="">
                <button type="submit" class="btn btn-primary" id="submitButton">บันทึกข้อมูล</button>
                <button type="button" class="btn btn-secondary d-none" id="cancelEditButton">ยกเลิกแก้ไข</button>
            </form>
        </div>
    </div>

    <hr class="my-4">
    <h3>ข้อมูลทั้งหมด</h3>
    
    <button id="refreshButton" class="btn btn-info mb-3 text-white">โหลดข้อมูลใหม่</button>
    <button id="logoutButton" class="btn btn-danger mb-3 ms-2">ออกจากระบบ</button>
    
    <table class="table table-striped table-bordered align-middle" id="dataTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Awsner</th>
                <th>Content</th>
                <th>Type</th>
                <th>จัดการ (U/D)</th>
            </tr>
        </thead>
        <tbody id="data-table-body">
            <tr><td colspan="5" class="text-center">กำลังโหลดข้อมูล...</td></tr>
        </tbody>
    </table>

    <script>
        // --- 0. LOGIN GUARD (สคริปต์ยาม) ---
        // สคริปต์นี้ต้องทำงานก่อนสคริปต์อื่นๆ เสมอ
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            // ถ้าไม่มี "ตั๋ว" (ยังไม่ล็อคอิน)
            alert("กรุณาเข้าสู่ระบบก่อนใช้งาน");
            // ส่งกลับไปหน้า login
            window.location.href = 'login.html';
        }
        // --- จบส่วนของสคริปต์ยาม ---


        // --- 1. การตั้งค่า ---
        const API_URL = "https://api.sheety.co/be7a568da72ea3c3f5afcce6605f9f2b/smartPrRetc/traning";
        const SHEET_NAME = "traning"; 

        // --- 2. อ้างอิง DOM Elements ---
        const form = document.getElementById('createForm');
        const tableBody = document.getElementById('data-table-body');
        const refreshButton = document.getElementById('refreshButton');
        
        const formTitle = document.getElementById('formTitle');
        const submitButton = document.getElementById('submitButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const editModeIdInput = document.getElementById('editModeId');
        
        const awsnerInput = document.getElementById('awsner');
        const contentInput = document.getElementById('content');
        const typeInput = document.getElementById('type');

        // --- 3. READ (GET) ---
        async function fetchData() {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">กำลังโหลด...</td></tr>';
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data[SHEET_NAME] && Array.isArray(data[SHEET_NAME])) {
                    renderTable(data[SHEET_NAME]);
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">รูปแบบข้อมูลไม่ถูกต้อง</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        }

        // --- ฟังก์ชันแสดงผลตาราง ---
        function renderTable(rows) {
            tableBody.innerHTML = '';
            if (rows.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">ไม่พบข้อมูล</td></tr>';
                return;
            }
            rows.forEach(row => {
                const tr = document.createElement('tr');
                let contentCellHtml;
                if (row.type === 'image') {
                    if(row.content) {
                        contentCellHtml = `<img src="${row.content}" alt="Image" class="table-image">`;
                    } else {
                        contentCellHtml = '(No Image URL)';
                    }
                } else {
                    contentCellHtml = row.content;
                }
                
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.awsner}</td> 
                    <td>${contentCellHtml}</td>
                    <td>${row.type}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="handleEdit(${row.id})">แก้ไข</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDelete(${row.id})">ลบ</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- 4. ฟังก์ชันสำหรับ Reset ฟอร์ม ---
        function resetForm() {
            form.reset(); 
            editModeIdInput.value = ''; 
            formTitle.innerText = 'เพิ่มข้อมูลใหม่';
            submitButton.innerText = 'บันทึกข้อมูล';
            submitButton.classList.replace('btn-warning', 'btn-primary'); 
            cancelEditButton.classList.add('d-none');
            contentInput.placeholder = "โปรดใส่ข้อความ...";
        }

        // --- 5. UPDATE (PUT) ---
        async function handleEdit(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const rowData = data[SHEET_NAME];
                
                awsnerInput.value = rowData.awsner;
                contentInput.value = rowData.content;
                typeInput.value = rowData.type; 

                updateContentPlaceholder();
                
                editModeIdInput.value = id;
                formTitle.innerText = `แก้ไขข้อมูล ID: ${id}`;
                submitButton.innerText = 'อัปเดตข้อมูล';
                submitButton.classList.replace('btn-primary', 'btn-warning');
                cancelEditButton.classList.remove('d-none'); 
                
                form.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error fetching data for edit:', error);
                alert('ไม่สามารถโหลดข้อมูลสำหรับแก้ไขได้');
            }
        }
        
        // --- 6. DELETE (DELETE) ---
        async function handleDelete(id) {
            if (!confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบแถว ID: ${id}?`)) {
                return;
            }
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                fetchData(); 
            } catch (error) {
                console.error('Error deleting data:', error);
                alert('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message);
            }
        }
        
        // --- ฟังก์ชันสำหรับเปลี่ยน Placeholder ---
        function updateContentPlaceholder() {
            if (typeInput.value === 'image') {
                contentInput.placeholder = "โปรดวาง URL ของรูปภาพที่นี่ (เช่น https://...)";
            } else {
                contentInput.placeholder = "โปรดใส่ข้อความ...";
            }
        }

        // --- 7. Event Listeners ---
        
        // ** SMART SUBMIT (CREATE or UPDATE) **
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            const id = editModeIdInput.value;
            const formData = {
                [SHEET_NAME]: {
                    awsner: awsnerInput.value,
                    content: contentInput.value,
                    type: typeInput.value 
                }
            };
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                resetForm(); 
                fetchData(); 
                
            } catch (error) {
                console.error(`Error ${method} data:`, error);
                alert(`เกิดข้อผิดพลาดในการบันทึกข้อมูล (${method})`);
            }
        });

        cancelEditButton.addEventListener('click', resetForm);
        refreshButton.addEventListener('click', fetchData);
        typeInput.addEventListener('change', updateContentPlaceholder);
        
        // *** ADD: Event listener สำหรับปุ่ม Logout ***
        document.getElementById('logoutButton').addEventListener('click', () => {
            if (confirm("คุณต้องการออกจากระบบหรือไม่?")) {
                sessionStorage.removeItem('isLoggedIn'); // ลบ "ตั๋ว" ทิ้ง
                window.location.href = 'login.html'; // ส่งกลับไปหน้า login
            }
        });
        
        // --- 8. Initial Load ---
        document.addEventListener('DOMContentLoaded', fetchData);
        
    </script>

</body>
</html>