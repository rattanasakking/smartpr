<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="https://uppic.retc.ac.th///uploads/691134e447aad.ico" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SMART PR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="dashboard-page">

    <div class="offcanvas-lg offcanvas-start sidebar-nav p-3" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        
        <div class="offcanvas-header">
            <a href="dashboard.html" class="d-flex align-items-center text-white text-decoration-none">
                <img src="https://uppic.retc.ac.th/uploads/690dedd77a750.png" alt="Logo" class="sidebar-logo me-2">
                <span class="fs-4">Admin Panel</span>
            </a>
            <button type="button" class="btn-close btn-close-white d-lg-none" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body d-flex flex-column">
            <hr class="text-white">
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link active" aria-current="page">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="crud.html" class="nav-link">
                        <i class="bi bi-chat-left-dots me-2"></i> ‡∏ñ‡∏≤‡∏° ‡∏ï‡∏≠‡∏ö AI
                    </a>
                </li>
                <li>
                    <a href="lastquetion.html" class="nav-link">
                        <i class="bi bi-clock-history me-2"></i> ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </a>
                </li>
                <li>
                    <a href="user.html" class="nav-link">
                        <i class="bi bi-people me-2"></i> User
                    </a>
                </li>
                <li>
                    <a href="https://smartpr.retc.ac.th/admin/stayin.html"  class="nav-link" target="_blank">
                        <i class="bi bi-line me-2"></i> ‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡∏° LINE Office
                    </a>
                </li>
                <li>
                    <a href="https://connext.aisdevio.ais.th" class="nav-link" target="_blank">
                        <i class="bi bi-broadcast me-2"></i> Beacon
                    </a>
                </li>
                <li>
                    <a href="https://uppic.retc.ac.th" class="nav-link" target="_blank">
                        <i class="bi bi-upload me-2"></i> ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    </a>
                </li>
                <li>
                    <a href="https://manager.line.biz/" class="nav-link" target="_blank">
                        <i class="bi bi-line me-2"></i> LINE OA
                    </a>
                </li>
            </ul>
            <hr class="text-white">
            <a href="#" id="logoutButton" class="nav-link logout-link">
                <i class="bi bi-box-arrow-right me-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </a>
        </div>
    </div>

    <div class="main-content">
        
        <nav class="navbar header-navbar sticky-top d-lg-none">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="dashboard.html">Dashboard</a>
            </div>
        </nav>

        <main class="container-fluid p-4">
            <h1>Dashboard SMART PR</h1>
            <p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</p>

            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-primary">
                                <i class="bi bi-chat-left-dots me-2"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏ñ‡∏≤‡∏°-‡∏ï‡∏≠‡∏ö (AI)
                            </h5>
                            <h2 class="card-text display-4" id="qa-count">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="bi bi-people me-2"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)
                            </h5>
                            <h2 class="card-text display-4" id="user-count">
                                <span class="spinner-border spinner-border-sm"></span>
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">

                <div class="col-lg-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-warning d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-clock-history me-2"></i> 5 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                                </span>
                                <span class="badge bg-warning rounded-pill" id="pending-count">
                                    <span class="spinner-border spinner-border-sm" style="width: 0.8rem; height: 0.8rem;"></span>
                                </span>
                            </h5>
                            
                            <div id="pending-questions-list" style="max-height: 400px; overflow-y: auto;">
                                <div class="d-flex justify-content-center p-3">
                                    <span class="spinner-border spinner-border-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-danger">
                                <i class="bi bi-fire me-2"></i> 5 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Æ‡∏¥‡∏ï (Popular Questions)
                            </h5>
                            <div id="popular-questions-list" style="max-height: 400px; overflow-y: auto;">
                                <div class="d-flex justify-content-center p-3">
                                    <span class="spinner-border spinner-border-sm"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div> 

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
            window.location.href = 'login.html';
        }
        
        const TR_API_URL = "https://api.sheety.co/423538c420e6cba4d60e9a41d250224e/chatGpt/traning";
        const USER_API_URL = "https://api.sheety.co/423538c420e6cba4d60e9a41d250224e/chatGpt/user";
        const PENDING_API_URL = "https://api.sheety.co/423538c420e6cba4d60e9a41d250224e/chatGpt/chatGptQuestion";
        const PENDING_SHEET_NAME = "chatGptQuestion";
        const DASHBOARD_API_URL = "https://api.sheety.co/423538c420e6cba4d60e9a41d250224e/chatGpt/dashboard";
        const DASHBOARD_SHEET_NAME = "dashboard";

        
        async function loadStats() {
            const qaCountEl = document.getElementById('qa-count');
            const userCountEl = document.getElementById('user-count');
            const pendingListEl = document.getElementById('pending-questions-list');
            const pendingCountEl = document.getElementById('pending-count');
            const popularListEl = document.getElementById('popular-questions-list');

            try {
                // (Fetch 1 & 2: QA Count & User Count)
                const responseQA = await fetch(TR_API_URL);
                const dataQA = await responseQA.json();
                qaCountEl.textContent = dataQA.traning ? dataQA.traning.length : '0';
                
                const responseUser = await fetch(USER_API_URL);
                const dataUser = await responseUser.json();
                userCountEl.textContent = dataUser.user ? dataUser.user.length : '0';

                // (Fetch 3: Pending Questions)
                const responsePending = await fetch(PENDING_API_URL);
                if (!responsePending.ok) throw new Error(`Pending API error! status: ${responsePending.status}`);
                const dataPending = await responsePending.json();
                
                const items = dataPending[PENDING_SHEET_NAME] || [];
                const count = items.length;
                
                pendingCountEl.textContent = `${count} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)`; 
                pendingListEl.innerHTML = ''; 
                
                if (count === 0) {
                    pendingListEl.innerHTML = '<p class="text-muted text-center p-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</p>';
                } else {
                    const latestItems = items.slice(-5).reverse();
                    let listHtml = '<ul class="list-group list-group-flush">';
                    latestItems.forEach(item => {
                        const name = item.name ? String(item.name).replace(/</g, "&lt;") : '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)';
                        const question = item.awnser ? String(item.awnser).replace(/</g, "&lt;") : '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)';
                        
                        listHtml += `<li class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${name}</div>
                                ${question}
                            </div>
                        </li>`;
                    });
                    listHtml += '</ul>';
                    pendingListEl.innerHTML = listHtml;
                }

                // (Fetch 4: Popular Questions)
                const responsePopular = await fetch(DASHBOARD_API_URL);
                if (!responsePopular.ok) throw new Error(`Dashboard API error! status: ${responsePopular.status}`);
                const dataPopular = await responsePopular.json();

                const rawItems = dataPopular[DASHBOARD_SHEET_NAME] || [];
                const popularItems = rawItems.slice(1); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2
                
                popularListEl.innerHTML = ''; 
                
                if (popularItems.length === 0) {
                    popularListEl.innerHTML = '<p class="text-muted text-center p-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Æ‡∏¥‡∏ï</p>';
                } else {
                    let listHtml = '<ul class="list-group list-group-flush">';
                    
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                    popularItems.sort((a, b) => (Number(b.countpopular || 0)) - (Number(a.countpopular || 0)));

                    // üü¢ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡πÉ‡∏ä‡πâ .slice(0, 5) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
                    const top5Items = popularItems.slice(0, 5);

                    top5Items.forEach(item => { // üü¢ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
                        const question = item.questionpopular ? String(item.questionpopular).replace(/</g, "&lt;") : '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)'; 
                        const hitCount = Number(item.countpopular || 0);
                        
                        listHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                            ${question}
                            <span class="badge bg-danger rounded-pill">${hitCount}</span>
                        </li>`;
                    });
                    listHtml += '</ul>';
                    popularListEl.innerHTML = listHtml;
                }


            } catch (error) {
                console.error('Error loading stats:', error);
                if (!qaCountEl.textContent) qaCountEl.textContent = 'Error';
                if (!userCountEl.textContent) userCountEl.textContent = 'Error';
                if (pendingCountEl.textContent.includes('spinner')) {
                     pendingCountEl.textContent = '!';
                     pendingListEl.innerHTML = '<p class="text-danger text-center p-3">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</p>';
                }
                popularListEl.innerHTML = '<p class="text-danger text-center p-3">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Æ‡∏¥‡∏ï</p>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            document.getElementById('logoutButton').addEventListener('click', () => {
                if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    sessionStorage.removeItem('isLoggedIn');
                    window.location.href = 'login.html';
                }
            });
        });
    </script>
</body>
</html>